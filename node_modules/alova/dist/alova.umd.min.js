!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).alova={})}(this,(function(e){"use strict";const t=Promise,o=e=>t.resolve(e),n=Object,r=void 0,s=null,a=!0,c=!1,i=(e,t,o)=>e.then(t,o),d=(e,t)=>e.catch(t),l=e=>e?e.getTime():Date.now(),u=e=>e.context,f=e=>e.config,h=e=>e.options,p=e=>h(u(e)),m=e=>h(e).statesHook,g=e=>JSON.stringify(e),y=e=>n.keys(e),v=(e,t)=>e.forEach(t),b=(e,...t)=>e.push(...t),S=e=>e.length,w=e=>Array.isArray(e),_=(e,t)=>delete e[t],E="memory",C="placeholder",R="restore",D="undefined"==typeof window,A=()=>{},T=e=>e,k=e=>"function"==typeof e,P=e=>"number"==typeof e&&!isNaN(e),$=e=>"string"==typeof e,x=e=>n.prototype.toString.call(e),U=e=>"[object Object]"===x(e),O=(e,t)=>e instanceof t,j=e=>{const{type:t,url:o,data:n}=e,{params:r,headers:s}=f(e);return g([t,o,r,n,s])},q=(e,t)=>{let o=s;return function(...n){const r=e.bind(this,...n);o&&(e=>{clearTimeout(e)})(o);const s=P(t)?t:t(...n);s>0?o=((e,t=0)=>setTimeout(e,t))(r,s):r()}},H=e=>{const t=f(e).localCache,o=e=>P(e)?l()+e:l(e);let n=E,s=0,a=c,i=r;if(!k(t))if(P(t)||O(t,Date))s=o(t);else{const{mode:e=E,expire:c=0,tag:d}=t||{};n=e,s=o(c),a=[C,R].includes(e),i=d?d.toString():r}return{e:s,m:n,s:a,t:i}},I=(e,t=[])=>k(e)?e(...t):e,N=e=>O(e,t)?e:o(e),L=(e,...t)=>new e(...t),M={},G=(e,t=a)=>{let o,n="",s=r;if($(e)||O(e,RegExp))s=e;else if(U(e)){s=e.name,o=e.filter;const t=e.alova;n=t?t.id:n}const c=[];return v(y(M),(e=>{if(!n||e===n){const t=M[e];v(y(t),(e=>{const o=t[e],n=f(o).name||"";(s===r||(O(s,RegExp)?s.test(n):n===s))&&(o.__key__=e,b(c,o))}))}})),o?c[t?"filter":"find"](o):t?c:c[0]},B=(e,t)=>{let o;return o=w(e)?e:e&&$(e.url)?t?[e]:e:G(e,t),o};let F={};const J=(e,t)=>{const o=F[e];if(o){const e=o[t];if(e){if(!(e[1]<l()))return e[0];_(o,t)}}},W=(e,t,o,n=0)=>{if(n>l()&&o){(F[e]=F[e]||{})[t]=[o,n]}},K=(e,t)=>"alova."+e+t,z=(e,t,o,n,r,a=s)=>{n>0&&o&&r.set(K(e,t),[o,n===1/0?s:n,a])},Q=(e,t,o,n=null)=>{const r=o.get(K(e,t));if(r){const[a,c,i=s]=r;if(i===n&&(!c||c>l()))return a;V(e,t,o)}},V=(e,t,o)=>{o.remove(K(e,t))};const X=e=>{if(!e)return void(F={});const t=B(e,a);v(t,(e=>{const{id:t,storage:o}=u(e),n=e.__key__||j(e);((e,t)=>{const o=F[e];o&&_(o,t)})(t,n),V(t,n,o)}))},Y={},Z=(e,t,o)=>{const n=(e=e.endsWith("/")?e.slice(0,-1):e)+(t=t.match(/^(\/|https?:\/\/)/)?t:`/${t}`),s=y(o).filter((e=>o[e]!==r)).map((e=>`${e}=${o[e]}`)).join("&");return s?+n.includes("?")?`${n}&${s}`:`${n}?${s}`:n};function ee(e,o){let n=r,s=a;return{abort:()=>n&&n.abort(),onDownload:e=>n&&n.onDownload&&n.onDownload(e),onUpload:e=>n&&n.onUpload&&n.onUpload(e),response:()=>{const{beforeRequest:i=A,responsed:d,responded:l,requestAdapter:h}=p(e),m=j(e),g=(e=>{const{data:t,config:o}=e,n={...o},{headers:r={},params:s={}}=n;return n.headers={...r},n.params={...s},L(te,e.type,u(e),e.url,n,t)})(e);return N(i(g)).then((()=>{const{localCache:e}=f(g);if(k(e))return e();if(!o){const e=J(u(g).id,m);if(e)return e}})).then((o=>{if(o!==r)return o;const{baseURL:i,url:p,type:y,data:v}=g,{id:b,storage:w}=u(g),{params:E={},headers:C={},transformData:R=T,name:D="",shareRequest:A}=f(g);s=c;const{e:P,s:$,t:j}=H(g),q=Y[b]=Y[b]||{};if(n=q[m],!A||!n){const e=h({url:Z(i,p,E),type:y,data:v,headers:C},g);n=q[m]=e}let I=T,L=r;const B=l||d;if(k(B))I=B;else if(U(B)){const{onSuccess:e,onError:t}=B;I=k(e)?e:I,L=k(t)?t:L}return t.all([n.response(),n.headers()]).then((([t,o])=>N(I(t,g)).then((e=>R(e,o))).then((t=>{((e,t,o)=>{(M[e]=M[e]||{})[t]=o})(b,m,e);const o=g.data,n=!o||!(e=>{const t=x(e);return/^\[object (Blob|FormData|ReadableStream|URLSearchParams)\]$/i.test(t)||O(e,ArrayBuffer)})(o);n&&(W(b,m,t,P),$&&z(b,m,t,P,w,j));const r=G({filter:e=>{let t=c;const o=e.hitSource;if(o)for(const e in o){const n=o[e];if(O(n,RegExp)?n.test(D):n===D||n===m){t=a;break}}return t}});return S(r)>0&&X(r),t}))),(e=>{if(!k(L))throw e;return L(e,g)})).finally((()=>_(q,m)))}))},fromCache:()=>s}}class te{constructor(e,t,o,n,s){const a=h(t);this.baseURL=a.baseURL||"",this.url=o,this.type=e,this.context=t;const c={};v(["timeout","shareRequest"],(e=>{a[e]!==r&&(c[e]=a[e])}));const i="localCache",d=U(a[i])?a[i][e]:r;d!==r&&(c[i]=d);const l=null==n?void 0:n.hitSource;l&&(this.hitSource=(w(l)?l:[l]).map((e=>O(e,te)?j(e):e)),_(n,"hitSource")),this.config={...c,headers:{},params:{},...n||{}},this.data=s}send(e=c){return ee(this,e).response()}setName(e){f(this).name=e}}const oe={},ne={getItem:e=>oe[e],setItem:(e,t)=>oe[e]=t,removeItem:e=>_(oe,e)};var re=()=>{const e=D?ne:window.localStorage;return{set:(t,o)=>e.setItem(t,g(o)),get:t=>{const o=e.getItem(t);return o?(n=o,JSON.parse(n)):o;var n},remove:t=>e.removeItem(t)}};const se=[],ae={localCache:{GET:3e5},shareRequest:a};let ce=0;class ie{constructor(e){this.id=++ce+"",this.storage=e.storageAdapter||re(),this.options={...ae,...e}}Get(e,t){return L(te,"GET",this,e,t)}Post(e,t={},o){return L(te,"POST",this,e,o,t)}Delete(e,t={},o){return L(te,"DELETE",this,e,o,t)}Put(e,t={},o){return L(te,"PUT",this,e,o,t)}Head(e,t){return L(te,"HEAD",this,e,t)}Patch(e,t={},o){return L(te,"PATCH",this,e,o,t)}Options(e,t){return L(te,"OPTIONS",this,e,t)}}var de=(e,t)=>{const o=L(Error,`[alova]${e}`);return t&&(o.name=t),o};function le(e,t){if(!e)throw de(t)}function ue(){le(S(se)>0,"please create a alova instance first.")}const fe={},he=(e,t)=>{const o=fe[e];return o?o[t]:r};var pe=(e,t)=>t(),me=(e,t,o,s,a,c,i)=>{const d={method:t,sendArgs:o,data:a,error:c,status:i,fromCache:s},l={};v(y(d),(e=>{d[e]!==r&&(l[e]=d[e])}));const u=["AlovaSuccessEvent","AlovaErrorEvent","AlovaCompleteEvent"][e];return u&&n.defineProperty(l,Symbol.toStringTag,{value:u}),l};function ge(e,n,s,l,h,p,m=[],g=c){const{force:b=c,middleware:w=pe}=s,{id:C,options:D,storage:T}=u(e),{update:P}=D.statesHook,$=j(e);let x=A,U=A;const{e:q,m:I,t:N}=H(e);let L=J(C,$);if(!g){const e=I!==E?Q(C,$,T,N):r;I===R&&!L&&e&&(W(C,$,e,q),L=e),(L||e)&&P({data:L||e},n),U=e=>((e,t,o)=>{(fe[e]=fe[e]||{})[t]=o})(C,$,e),U(n),x=()=>((e,t)=>{const o=fe[e];o&&_(o,t)})(C,$)}let M={},G=o(r),B=()=>!!L;let F,K,z;const V=w({method:e,cachedResponse:L,sendArgs:m,config:s,frontStates:n,update:e=>P(e,n),decorateSuccess:e=>{k(e)&&(F=e)},decorateError:e=>{k(e)&&(K=e)},decorateComplete:e=>{k(e)&&(z=e)}},(t=>{const{force:o=b,method:r=e}=t||{},s=((e,t=[])=>k(e)?e(...t):e)(o,m),{response:c,onDownload:i=A,onUpload:d=A,fromCache:l}=M=ee(r,s);B=l,!s&&L||P({loading:a},n),G=c();const u=e=>(t,o)=>{P({[e]:{loaded:t,total:o}},n)},{enableDownload:h,enableUpload:p}=f(e);return h&&i(u("downloading")),p&&d(u("uploading")),G}));le(O(V,t),"middleware must be a async function");const X=(e,t,o)=>{v(e,((n,r)=>k(t)?t(n,o,r,S(e)):n(o)))},Y=d(i(V,(t=>{const o=t=>{if(g){const e=he(C,$);e&&P({data:t},e)}else P({data:t},n);return P({loading:c},n),X(l,F,me(0,e,m,B(),t)),X(p,z,me(2,e,m,B(),t,r,"success")),t};return t!==r?o(t):S(y(M))>0?i(G,o,(()=>o(r))):void 0})),(o=>{return P({error:o,loading:c},n),X(h,K,me(1,e,m,B(),r,o)),X(p,z,me(2,e,m,B(),r,o,"error")),s=o,t.reject(s);var s}));return{...M,p:Y,r:x,s:U}}function ye(e,t,o,n,s=c,i,l=0){const{create:u,export:f,effectRequest:h,update:p}=m(e),g={total:0,loaded:0},{managedStates:y={}}=o,v={...y,data:u(n),loading:u(c),error:u(r),downloading:u({...g}),uploading:u({...g})},S=[],_=[],E=[];let C=r,R=A,D=A;const T=(e,t=o,n,r)=>{const{abort:s,p:a,r:c,s:i}=ge(e,v,t,S,_,E,n,r);return C=s,R=c,D=i,a},k=()=>{const e=I(t);d(T(e),A)};h({handler:i!==r?q(k,(e=>P(e)?w(l)?l[e]:l:0)):k,removeStates:()=>R(),saveStates:e=>D(e),frontStates:v,watchingStates:i,immediate:null!=s?s:a});return{...{loading:f(v.loading),data:f(v.data),error:f(v.error),downloading:f(v.downloading),uploading:f(v.uploading)},onSuccess(e){b(S,e)},onError(e){b(_,e)},onComplete(e){b(E,e)},update(e){p(e,v)},abort:()=>(C||A)(),send:(e,n,r)=>T(n||I(t,e),o,e,r)}}e.Method=te,e.createAlova=e=>{const t=L(ie,e);return se[0]&&le(m(se[0])===m(t),"must use the same statesHook in one environment"),b(se,t),t},e.getMethodKey=j,e.invalidateCache=X,e.matchSnapshotMethod=G,e.queryCache=e=>{const t=B(e,c);if(t){const{id:e,storage:o}=u(t),n=t.__key__||j(t);return J(e,n)||Q(e,n,o,H(t).t)}},e.setCache=(e,t)=>{const o=B(e,a);v(o,(e=>{const{id:o,storage:n}=u(e),s=e.__key__||j(e),{e:a,s:c,t:i}=H(e);let d=t;if(k(t)){const e=J(o,s)||Q(o,s,n,i);if(d=t(e),d===r)return}W(o,s,d,a),c&&z(o,s,d,a,n,i)}))},e.updateState=function(e,t,o={}){const{onMatch:n=A}=o,s=B(e,c);let i=c;if(s){n(s);const{statesHook:{dehydrate:e,update:o}}=p(s),c=s.__key__||j(s),{id:d,storage:l}=u(s),f=he(d,c);if(f){const{e:n,s:u,t:h}=H(s),p=k(t)?{data:t}:t;v(y(p),(t=>{le(f[t]!==r,`can not find state named \`${t}\``),le(!y(f).slice(-4).includes(t),"can not update preset states");try{const r=p[t](e(f[t]));o({[t]:r},f),W(d,c,r,n),u&&z(d,c,r,n,l,h)}catch(e){throw de(`managed state \`${t}\` must be a state.`)}})),i=a}}return i},e.useFetcher=function(e={}){ue();const t=ye(se[0],A,e);return{fetching:t.loading,error:t.error,downloading:t.downloading,uploading:t.uploading,onSuccess:t.onSuccess,onError:t.onError,onComplete:t.onComplete,abort:t.abort,fetch:(e,...o)=>{const n=B(e,c);le(!!n,"method instance is not found"),t.send(o,n,a)}}},e.useRequest=function(e,t={}){ue();const{immediate:o=a,initialData:n}=t,r=ye(se[0],e,t,n,!!o);return{...r,send:(...e)=>r.send(e)}},e.useWatcher=function(e,t,o={}){le(t&&S(t)>0,"must specify at least one watching state"),ue();const{immediate:n,debounce:r=0,initialData:s}=o,a=ye(se[0],e,o,s,!!n,t,r);return{...a,send:(...e)=>a.send(e)}},Object.defineProperty(e,"__esModule",{value:!0})}));
